parameters:
  serviceConnection: ''
  terraformstoragerg: ''
  location: ''

steps:
- task: AzureCLI@1
  inputs:
    azureSubscription: ${{ parameters.serviceConnection }}
    scriptLocation: 'inlineScript'
    inlineScript:
      STORAGEACCT=$(az storage account create \
      --resource-group ${{ parameters.terraformstoragerg }} \
      --name "rdoperftesttf$RANDOM" \
      --location ${{ parameters.location }} \
      --sku Standard_LRS | tr -d '"')

      STORAGECONT=$(az storage container create \
      --name "terraform" \
      --account-name $STORAGEACCT | tr -d '"')

      STORAGEKEY=$(az storage account keys list \
      --resource-group $1 \
      --account-name $STORAGEACCT \
      --query "[0].value" | tr -d '"')
    
- script: |      
    echo "##vso[task.setvariable variable=terraformstorageaccount;isOutput=true]$STORAGEACCT"
    echo "##vso[task.setvariable variable=storagekey;isOutput=true]$STORAGEKEY"
  displayName: PrepareStorageAccount
  name: createStorage
