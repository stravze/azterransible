# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  keyvaultName: 'rdo-runbook'
  serviceConnection: 'sp-conn'

jobs:
- job: ReadKeyVault
  pool:
    vmImage: 'Ubuntu 16.04'
  steps:
  - template: ../steps/keyvault-read.yaml
    parameters:
      serviceConnection: $(serviceConnection)
      keyvaultName: $(keyvaultName)

- job: PrepareArtifacts
  steps:
  - task: CopyFiles@2
    displayName: 'Copy Terraform files to artifacts'
    inputs:
      SourceFolder: terraform
      TargetFolder: '$(build.artifactstagingdirectory)/terraform'

  - task: CopyFiles@2
    displayName: 'Copy Ansible files to artifacts'
    inputs:
      SourceFolder: ansible
      TargetFolder: '$(build.artifactstagingdirectory)/ansible'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'

- job: InstallSSHkey 
  pool:
      vmImage: 'Ubuntu-16.04'
  steps:
  - task: InstallSSHkey@0
    inputs:
      hostName: 'default'
      sshPublicKey: '$(SSH_PUB_KEY)'
      sshKeySecureFile: 'github'